# 대장암 다기관 임상 데이터 전처리 및 통합 진행 상황 정리

## 1. 프로젝트 목적 및 개요

- **목적**: 국립암센터, 삼성서울병원, 연세대학교병원 등 다기관에서 수집된 대장암 임상 데이터를 환자 중심(wide-format)으로 통합·전처리하여, 생존분석 및 머신러닝/딥러닝 모델링에 최적화된 분석용 데이터셋을 구축하는 것.
- **범위**: 환자 기본 정보, 진단검사, 수술, 항암/방사선 치료, 병리/분자/면역, 사망 정보 등 다양한 테이블을 통합하고, 임상적으로 중요한 파생 변수를 생성.

## 2. 전체 전처리 및 통합 흐름

### 2.1 환경 설정 및 데이터 로드

- R 기반(tidyverse)으로 모든 병원별 원본 CSV 데이터를 불러옴.
- 인코딩(CP949/UTF-8 등) 자동 처리, 컬럼명 차이 유연하게 대응.

### 2.2 환자 중심 테이블 구축

- `clrc_pt_bsnf.csv`(환자 기본 정보)를 중심축으로, **환자별 1행(row)만 유지**하는 wide-format 데이터셋 생성.
- 환자 고유번호(PT_SBST_NO)를 모든 병합의 기준 키로 사용.

### 2.3 주요 테이블별 전처리 및 병합 전략

#### (1) 진단검사 데이터 (`clrc_ex_diag.csv`)

- **주요 검사(CEA, CA19-9 등)만 추출**.
- **진단시점 검사값**: 진단일 ±30일 내 검사값의 평균.
- **전체 기간 최대값**: 환자별 검사별 최대값.
- **파생 변수 예시**: `진단시점_CEA`, `최고_CEA`, `진단시점_CA19-9` 등.
- **결측값/미시행은 NA로 처리**.

#### (2) 수술 데이터 (`clrc_oprt_nfrm.csv`)

- **첫 수술(진단일 이후) 정보만 추출**: `첫수술일자`, `첫수술명`, `수술여부(Y/N)`.
- **수술 횟수**: 환자별 총 수술 횟수.
- **수술 미시행 환자 명확 구분**.

#### (3) 항암/방사선 치료 데이터 (`clrc_trtm_casb.csv`, `clrc_trtm_rd.csv`)

- **항암치료**: 최초 치료일(`최초항암치료일`), 치료횟수(`항암치료횟수`), 주요 regimen별 플래그(`FOLOFOX_여부`, `CAPEOX_여부`), 항암치료여부(Y/N).
- **방사선치료**: 최초 치료일(`최초방사선치료일`), 치료횟수(`방사선치료횟수`), 방사선치료여부(Y/N).
- **치료 미시행 환자 결측/플래그로 구분**.

#### (4) 병리/분자/면역 데이터

- **KRAS, MSI 등 주요 결과만 추출**.
- **MSI 정보**: 분자병리 우선, 없으면 면역조직화학 결과 사용.
- **파생 변수 예시**: `KRAS_MUTATION`, `MSI_STATUS`.

#### (5) 사망 정보 (`clrc_dead_nfrm.csv`)

- **사망여부(Y/N)**, **사망일자**, **생존기간(일)** 등 파생.
- 사망 정보가 없으면 생존자로 간주, 최종 방문일 기준 생존기간 산출.

## 3. 코드 구조 및 주요 함수

- **함수화 및 재사용성**: 데이터 유형별로 함수(`process_lab_data`, `process_surgery_data`, `process_treatment_data`, `process_pathology_data`, `process_death_data`)를 분리해 유지보수와 확장 용이.
- **기관별 변수명/코드 자동 처리**: rename_with, any_of 등으로 유연하게 대응.
- **결측치/이상치/코드값 표준화**: NA, 99 등 일관 처리.

## 4. 주요 파생 변수 생성 기준

| 변수명              | 생성 기준 및 설명                                                  |
|---------------------|-------------------------------------------------------------------|
| 진단시점_CEA        | 진단일 ±30일 내 CEA 수치(평균)                                    |
| 최고_CEA            | 전체 기간 중 CEA 수치의 최대값                                     |
| 수술여부            | 진단일 이후 수술 기록이 있으면 "Y", 없으면 "N"                   |
| 첫수술일자          | 진단일 이후 최초 수술일자                                         |
| 항암치료여부        | 항암치료 기록이 있으면 "Y", 없으면 "N"                            |
| FOLOFOX_여부        | FOLOFOX 요법 시행 여부                                            |
| MSI_STATUS          | 분자병리 결과 우선, 없으면 면역조직화학 결과 사용                 |
| KRAS_MUTATION       | KRAS 변이 여부(있는 경우 "Y", 없으면 "N")                         |
| 사망여부            | 사망 정보가 있으면 "Y", 없으면 "N"                                |
| 생존기간_일         | 진단일~사망일 또는 진단일~최종 방문일(생존자)까지 일수            |

## 5. 데이터 품질 관리 및 표준화

- **결측치/이상치 처리**: NA, 99 등 일관 처리, 결측률 높은 변수는 별도 관리.
- **기관별 변수명/코드 표준화**: 병합 전 표준 변수명/코드로 변환.
- **파생 변수 기준 문서화**: 진단시점(±30일 등), 최초/최고값 기준 등 코드북에 명확히 기록.
- **임상적 타당성 검토**: 변수 요약 기준이 임상 표준과 일치하는지 논문/가이드라인 참고.

## 6. 특수 데이터 정규화(국립암센터 생년월일)

- **문제**: 국립암센터의 `기본환자생년월`이 `YYYY-MM` → `월-YY`로 잘못 변환되는 이슈.
- **해결**: 두 자리 연도는 모두 `1900+YY`로 변환하여 일관성 확보.

## 7. 최종 산출물 및 활용

- **병원별 wide-format 데이터셋**:  
  - `ncc_clrc_features.csv`  
  - `smc_clrc_features.csv`  
  - `yonsei_clrc_features.csv`
- **후속 분석**: EDA, 생존분석, 머신러닝/딥러닝 모델링에 바로 활용 가능.

## 8. 추가 권고 및 다음 단계

- **결측치/이상치 현황 추가 점검**: 변수별 결측률, 이상값(음수, 비현실적 수치 등) 확인.
- **기관별 변수 표준화 강화**: 동일 변수라도 단위/코드 차이 재확인.
- **코드북(Codebook) 작성**: 모든 변수(원본 및 파생)의 정의, 값의 범위, 생성 기준 등 상세 기록.
- **임상적 타당성 재확인**: 변수 요약 기준이 실제 임상 해석과 일치하는지 검토.
- **분석 목적별 파생 변수 조정**: 예측모델, 위험인자 분석 등 목적에 따라 추가 파생/요약 필요시 유연하게 조정.

## 9. 요약

- 환자 중심 wide-format, 임상적으로 의미 있는 변수 요약/파생, 결측/이상치/코드값 표준화 등 **실제 임상 데이터 분석 및 머신러닝/생존분석 프로젝트에서 요구되는 표준과 모범사례에 부합**하는 구조로 전처리가 잘 진행됨.
- 추가로 결측치 현황 점검, 파생 기준 문서화, 임상적 타당성 재확인만 보완하면, **신뢰성 높은 분석용 데이터셋**으로 활용 가능.
